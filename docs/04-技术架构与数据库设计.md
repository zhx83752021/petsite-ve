# 宠物网需求文档 - 技术架构与数据库设计
## 四、技术架构设计
### 4.1 技术栈选型
#### 4.1.1 前端技术栈
| 技术             | 版本    | 用途说明                          |
| ---------------- | ------- | --------------------------------- |
| **Vue3**         | ^3.4.0  | 渐进式 JavaScript 框架,组合式 API |
| **Vite**         | ^5.0.0  | 极速的构建工具                    |
| **TypeScript**   | ^5.3.0  | 类型安全,提升代码质量             |
| **Pinia**        | ^2.1.0  | 状态管理,替代 Vuex                |
| **Vue Router**   | ^4.2.0  | 官方路由管理器                    |
| **Element Plus** | ^2.5.0  | UI 组件库                         |
| **Axios**        | ^1.6.0  | HTTP 客户端                       |
| **ECharts**      | ^5.4.0  | 数据可视化图表库                  |
| **VueUse**       | ^10.7.0 | Vue 组合式 API 工具集             |
| **Tailwind CSS** | ^3.4.0  | 原子化 CSS 框架                   |
| **Day.js**       | ^1.11.0 | 日期处理库                        |
| **Lodash-es**    | ^4.17.0 | 工具函数库                        |
#### 4.1.2 后端技术栈
| 技术           | 版本     | 用途说明          |
| -------------- | -------- | ----------------- |
| **Node.js**    | ^20.10.0 | JavaScript 运行时 |
| **Express**    | ^4.18.0  | Web 应用框架      |
| **TypeScript** | ^5.3.0   | 类型安全          |
| **PostgreSQL** | ^14.0    | 关系型数据库      |
| **Sequelize**  | ^6.35.0  | ORM 框架          |
| **Redis**      | ^7.2.0   | 缓存数据库        |
| **JWT**        | ^9.0.0   | 身份认证          |
| **Bcrypt**     | ^5.1.0   | 密码加密          |
| **Multer**     | ^1.4.0   | 文件上传          |
| **Joi**        | ^17.12.0 | 数据验证          |
| **Winston**    | ^3.11.0  | 日志管理          |
| **Socket.IO**  | ^4.6.0   | 实时通信          |
#### 4.1.3 开发工具
| 工具           | 用途         |
| -------------- | ------------ |
| **ESLint**     | 代码检查     |
| **Prettier**   | 代码格式化   |
| **Husky**      | Git 钩子     |
| **Commitlint** | 提交信息规范 |
| **Jest**       | 单元测试     |
| **Docker**     | 容器化部署   |
### 4.2 系统架构图
```
┌─────────────────────────────────────────────────────────────────┐
│                          用户层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │   PC端   │  │  移动端  │  │  平板端  │  │  小程序  │       │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘       │
└────────┼─────────────┼─────────────┼─────────────┼─────────────┘
         │             │             │             │
         └─────────────┴─────────────┴─────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       CDN加速层(Vercel CDN)                      │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    前端应用层(Vue3+Vite)                         │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  路由层(Vue Router) + 状态管理(Pinia) + UI组件(Element+)  │ │
│  └────────────────────────────────────────────────────────────┘ │
└───────────────────────────┬─────────────────────────────────────┘
                            │ HTTPS/WebSocket
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    API网关层(Nginx/Vercel)                       │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐               │
│  │ 负载均衡│  │ 鉴权   │  │ 限流   │  │ 日志   │               │
│  └────────┘  └────────┘  └────────┘  └────────┘               │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                 应用服务层(Node.js+Express)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 用户服务 │  │ 商品服务 │  │ 订单服务 │  │ 社区服务 │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 支付服务 │  │ 消息服务 │  │ 文件服务 │  │ 搜索服务 │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ PostgreSQL │  │  Redis   │  │   OSS    │  │ RabbitMQ │       │
│  │ 主从复制 │  │  缓存    │  │ 文件存储 │  │  消息队列│       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└─────────────────────────────────────────────────────────────────┘
```
### 4.3 项目目录结构
#### 4.3.1 前端项目结构
```
pet-web-frontend/
├── public/                  # 静态资源
│   ├── favicon.ico
│   └── logo.png
├── src/
│   ├── assets/             # 资源文件
│   │   ├── images/         # 图片
│   │   ├── styles/         # 全局样式
│   │   │   ├── index.css
│   │   │   ├── variables.css
│   │   │   └── tailwind.css
│   │   └── icons/          # 图标
│   ├── components/         # 公共组件
│   │   ├── common/         # 通用组件
│   │   │   ├── AppHeader.vue
│   │   │   ├── AppFooter.vue
│   │   │   ├── AppLoading.vue
│   │   │   └── AppEmpty.vue
│   │   ├── business/       # 业务组件
│   │   │   ├── ProductCard.vue
│   │   │   ├── PostCard.vue
│   │   │   └── UserAvatar.vue
│   │   └── index.ts        # 组件导出
│   ├── views/              # 页面组件
│   │   ├── home/           # 首页
│   │   │   └── Index.vue
│   │   ├── shop/           # 商城
│   │   │   ├── ProductList.vue
│   │   │   ├── ProductDetail.vue
│   │   │   ├── Cart.vue
│   │   │   └── OrderConfirm.vue
│   │   ├── community/      # 社区
│   │   │   ├── Index.vue
│   │   │   ├── PostDetail.vue
│   │   │   └── Publish.vue
│   │   ├── service/        # 服务
│   │   │   ├── Consult.vue
│   │   │   ├── Beauty.vue
│   │   │   └── Adopt.vue
│   │   ├── user/           # 个人中心
│   │   │   ├── Profile.vue
│   │   │   ├── Orders.vue
│   │   │   └── Pets.vue
│   │   └── admin/          # 后台管理
│   │       ├── Dashboard.vue
│   │       ├── Products.vue
│   │       └── Orders.vue
│   ├── router/             # 路由配置
│   │   ├── index.ts
│   │   └── routes.ts
│   ├── stores/             # 状态管理
│   │   ├── user.ts
│   │   ├── cart.ts
│   │   ├── product.ts
│   │   └── index.ts
│   ├── api/                # API接口
│   │   ├── request.ts      # axios封装
│   │   ├── user.ts
│   │   ├── product.ts
│   │   ├── order.ts
│   │   └── community.ts
│   ├── utils/              # 工具函数
│   │   ├── index.ts
│   │   ├── format.ts       # 格式化
│   │   ├── validate.ts     # 验证
│   │   └── storage.ts      # 本地存储
│   ├── hooks/              # 自定义Hooks
│   │   ├── useAuth.ts
│   │   ├── useCart.ts
│   │   └── useInfiniteScroll.ts
│   ├── types/              # TypeScript类型
│   │   ├── user.ts
│   │   ├── product.ts
│   │   └── api.ts
│   ├── directives/         # 自定义指令
│   │   ├── permission.ts
│   │   └── lazyload.ts
│   ├── plugins/            # 插件
│   │   └── element-plus.ts
│   ├── App.vue            # 根组件
│   └── main.ts            # 入口文件
├── .env.development       # 开发环境变量
├── .env.production        # 生产环境变量
├── .eslintrc.js          # ESLint配置
├── .prettierrc.js        # Prettier配置
├── tailwind.config.js    # Tailwind配置
├── tsconfig.json         # TypeScript配置
├── vite.config.ts        # Vite配置
└── package.json          # 项目配置
```
#### 4.3.2 后端项目结构
```
pet-web-backend/
├── src/
│   ├── config/            # 配置文件
│   │   ├── database.ts    # 数据库配置
│   │   ├── redis.ts       # Redis配置
│   │   ├── jwt.ts         # JWT配置
│   │   └── upload.ts      # 文件上传配置
│   ├── models/            # 数据模型
│   │   ├── User.ts
│   │   ├── Product.ts
│   │   ├── Order.ts
│   │   ├── Post.ts
│   │   └── index.ts
│   ├── controllers/       # 控制器
│   │   ├── user.controller.ts
│   │   ├── product.controller.ts
│   │   ├── order.controller.ts
│   │   └── community.controller.ts
│   ├── services/          # 业务逻辑
│   │   ├── user.service.ts
│   │   ├── product.service.ts
│   │   ├── order.service.ts
│   │   └── payment.service.ts
│   ├── routes/            # 路由
│   │   ├── index.ts
│   │   ├── user.routes.ts
│   │   ├── product.routes.ts
│   │   └── order.routes.ts
│   ├── middleware/        # 中间件
│   │   ├── auth.middleware.ts
│   │   ├── validation.middleware.ts
│   │   ├── error.middleware.ts
│   │   └── logger.middleware.ts
│   ├── validators/        # 数据验证
│   │   ├── user.validator.ts
│   │   └── product.validator.ts
│   ├── utils/             # 工具函数
│   │   ├── response.ts    # 统一响应
│   │   ├── crypto.ts      # 加密
│   │   ├── upload.ts      # 文件上传
│   │   └── logger.ts      # 日志
│   ├── types/             # 类型定义
│   │   ├── express.d.ts
│   │   └── index.ts
│   ├── database/          # 数据库
│   │   ├── migrations/    # 迁移文件
│   │   └── seeders/       # 种子数据
│   ├── app.ts            # Express应用
│   └── server.ts         # 服务器入口
├── .env.development      # 开发环境变量
├── .env.production       # 生产环境变量
├── .eslintrc.js         # ESLint配置
├── tsconfig.json        # TypeScript配置
└── package.json         # 项目配置
```
### 4.4 核心模块设计
#### 4.4.1 认证鉴权模块
**JWT 认证流程：**
```
用户登录 → 验证账号密码 → 生成JWT Token → 返回Token
   ↓
用户请求 → 携带Token → 验证Token → 解析用户信息 → 处理请求
```
**实现代码：**
```typescript
// middleware/auth.middleware.ts
import jwt from "jsonwebtoken";
export const authMiddleware = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    const token = req.headers.authorization?.replace("Bearer ", "");
    if (!token) {
      return res.status(401).json({ message: "未授权访问" });
    }
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as JWTPayload;
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ message: "Token无效或已过期" });
  }
};
// 生成Token
export const generateToken = (userId: string): string => {
  return jwt.sign({ userId, timestamp: Date.now() }, process.env.JWT_SECRET!, {
    expiresIn: "7d",
  });
};
```
#### 4.4.2 文件上传模块
**上传流程：**
```
客户端选择文件 → 上传到服务器 → 验证文件 → 存储到OSS → 返回URL
```
**实现代码：**
```typescript
// utils/upload.ts
import multer from "multer";
import path from "path";
import { v4 as uuidv4 } from "uuid";
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads/");
  },
  filename: (req, file, cb) => {
    const ext = path.extname(file.originalname);
    const filename = `${uuidv4()}${ext}`;
    cb(null, filename);
  },
});
export const upload = multer({
  storage,
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB
  },
  fileFilter: (req, file, cb) => {
    const allowedTypes = ["image/jpeg", "image/png", "image/gif"];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error("不支持的文件类型"));
    }
  },
});
```
#### 4.4.3 缓存模块
**Redis 缓存策略：**
```typescript
// utils/cache.ts
import Redis from "ioredis";
const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: Number(process.env.REDIS_PORT),
  password: process.env.REDIS_PASSWORD,
});
export class CacheService {
  // 设置缓存
  static async set(key: string, value: any, ttl?: number): Promise<void> {
    const data = JSON.stringify(value);
    if (ttl) {
      await redis.setex(key, ttl, data);
    } else {
      await redis.set(key, data);
    }
  }
  // 获取缓存
  static async get<T>(key: string): Promise<T | null> {
    const data = await redis.get(key);
    return data ? JSON.parse(data) : null;
  }
  // 删除缓存
  static async del(key: string): Promise<void> {
    await redis.del(key);
  }
  // 批量删除
  static async delPattern(pattern: string): Promise<void> {
    const keys = await redis.keys(pattern);
    if (keys.length > 0) {
      await redis.del(...keys);
    }
  }
}
```
**缓存使用示例：**
```typescript
// 获取商品详情（带缓存）
async getProductDetail(id: string) {
  const cacheKey = `product:${id}`
  // 尝试从缓存获取
  let product = await CacheService.get(cacheKey)
  if (!product) {
    // 缓存未命中，从数据库查询
    product = await Product.findByPk(id)
    if (product) {
      // 写入缓存，过期时间1小时
      await CacheService.set(cacheKey, product, 3600)
    }
  }
  return product
}
```
---
## 五、数据库设计
### 5.1 数据库设计原则
1. **范式设计**：遵循第三范式，减少数据冗余
2. **索引优化**：为常用查询字段创建索引
3. **字段命名**：使用小写+下划线命名法
4. **时间戳**：统一使用`created_at`和`updated_at`
5. **软删除**：使用`deleted_at`字段标记删除
6. **字符集**：统一使用`utf8mb4`支持 emoji
### 5.2 ER 关系图
```
用户表(users) ──┬─1:N─→ 宠物表(pets)
              │
              ├─1:N─→ 地址表(addresses)
              │
              ├─1:N─→ 订单表(orders) ──1:N─→ 订单明细表(order_items)
              │                      └─1:1─→ 订单物流表(order_shipping)
              │
              ├─1:N─→ 购物车表(cart_items)
              │
              ├─1:N─→ 动态表(posts) ──┬─1:N─→ 评论表(comments)
              │                      └─M:N─→ 话题表(topics)
              │
              └─1:N─→ 收藏表(favorites)
商品表(products) ──┬─N:1─→ 分类表(categories)
                 │
                 ├─N:1─→ 品牌表(brands)
                 │
                 ├─1:N─→ SKU表(product_skus)
                 │
                 └─1:N─→ 评价表(reviews)
```
### 5.3 核心数据表设计
#### 5.3.1 用户相关表
**用户表(users)**
```sql
CREATE TABLE `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码(加密)',
  `nickname` VARCHAR(50) NOT NULL COMMENT '昵称',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `phone` VARCHAR(20) NOT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `gender` TINYINT DEFAULT NULL COMMENT '性别:1男2女',
  `birthday` DATE DEFAULT NULL COMMENT '生日',
  `signature` VARCHAR(200) DEFAULT NULL COMMENT '个性签名',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态:1正常2禁用',
  `last_login_at` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` DATETIME DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_phone` (`phone`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```
**宠物表(pets)**
```sql
CREATE TABLE `pets` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '宠物ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '宠物头像',
  `name` VARCHAR(50) NOT NULL COMMENT '宠物名字',
  `species` TINYINT NOT NULL COMMENT '物种:1犬2猫3其他',
  `breed` VARCHAR(50) DEFAULT NULL COMMENT '品种',
  `gender` TINYINT DEFAULT NULL COMMENT '性别:1公2母',
  `birthday` DATE DEFAULT NULL COMMENT '生日',
  `adopt_date` DATE DEFAULT NULL COMMENT '领养日期',
  `weight` DECIMAL(5,2) DEFAULT NULL COMMENT '体重(kg)',
  `is_neutered` TINYINT DEFAULT 0 COMMENT '是否绝育:0否1是',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_pets_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='宠物表';
```
**地址表(addresses)**
```sql
CREATE TABLE `addresses` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `name` VARCHAR(50) NOT NULL COMMENT '收货人',
  `phone` VARCHAR(20) NOT NULL COMMENT '手机号',
  `province` VARCHAR(50) NOT NULL COMMENT '省',
  `city` VARCHAR(50) NOT NULL COMMENT '市',
  `district` VARCHAR(50) NOT NULL COMMENT '区',
  `detail` VARCHAR(200) NOT NULL COMMENT '详细地址',
  `is_default` TINYINT NOT NULL DEFAULT 0 COMMENT '是否默认:0否1是',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_addresses_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='地址表';
```
#### 5.3.2 商品相关表
**商品分类表(categories)**
```sql
CREATE TABLE `categories` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `parent_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '父分类ID',
  `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
  `icon` VARCHAR(255) DEFAULT NULL COMMENT '图标',
  `sort` INT NOT NULL DEFAULT 0 COMMENT '排序',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态:1启用2禁用',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品分类表';
```
**品牌表(brands)**
```sql
CREATE TABLE `brands` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(50) NOT NULL COMMENT '品牌名称',
  `logo` VARCHAR(255) DEFAULT NULL COMMENT '品牌logo',
  `description` TEXT COMMENT '品牌描述',
  `sort` INT NOT NULL DEFAULT 0,
  `status` TINYINT NOT NULL DEFAULT 1,
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='品牌表';
```
**商品表(products)**
```sql
CREATE TABLE `products` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `category_id` BIGINT UNSIGNED NOT NULL COMMENT '分类ID',
  `brand_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '品牌ID',
  `name` VARCHAR(200) NOT NULL COMMENT '商品名称',
  `subtitle` VARCHAR(200) DEFAULT NULL COMMENT '副标题',
  `main_images` JSON NOT NULL COMMENT '主图URL数组',
  `detail` TEXT NOT NULL COMMENT '商品详情',
  `pet_type` TINYINT DEFAULT NULL COMMENT '适用宠物:1犬2猫3其他',
  `age_range` VARCHAR(50) DEFAULT NULL COMMENT '适用年龄',
  `ingredients` TEXT DEFAULT NULL COMMENT '成分配料',
  `attributes` JSON DEFAULT NULL COMMENT '商品属性JSON',
  `sales` INT NOT NULL DEFAULT 0 COMMENT '销量',
  `views` INT NOT NULL DEFAULT 0 COMMENT '浏览量',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态:1上架2下架',
  `seo_title` VARCHAR(200) DEFAULT NULL,
  `seo_keywords` VARCHAR(200) DEFAULT NULL,
  `seo_description` VARCHAR(500) DEFAULT NULL,
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_brand_id` (`brand_id`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_products_category` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`),
  CONSTRAINT `fk_products_brand` FOREIGN KEY (`brand_id`) REFERENCES `brands` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';
```
**商品 SKU 表(product_skus)**
```sql
CREATE TABLE `product_skus` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `product_id` BIGINT UNSIGNED NOT NULL COMMENT '商品ID',
  `sku_code` VARCHAR(50) NOT NULL COMMENT 'SKU编码',
  `spec_combination` VARCHAR(200) NOT NULL COMMENT '规格组合',
  `price` DECIMAL(10,2) NOT NULL COMMENT '价格',
  `original_price` DECIMAL(10,2) DEFAULT NULL COMMENT '原价',
  `stock` INT NOT NULL DEFAULT 0 COMMENT '库存',
  `weight` INT DEFAULT NULL COMMENT '重量(克)',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态:1启用2禁用',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_sku_code` (`sku_code`),
  KEY `idx_product_id` (`product_id`),
  CONSTRAINT `fk_skus_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品SKU表';
```
#### 5.3.3 订单相关表
**订单表(orders)**
```sql
CREATE TABLE `orders` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `order_no` VARCHAR(32) NOT NULL COMMENT '订单号',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `total_amount` DECIMAL(10,2) NOT NULL COMMENT '商品总额',
  `discount_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '优惠金额',
  `shipping_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '运费',
  `pay_amount` DECIMAL(10,2) NOT NULL COMMENT '实付金额',
  `pay_method` TINYINT DEFAULT NULL COMMENT '支付方式:1在线2货到付款',
  `pay_status` TINYINT NOT NULL DEFAULT 1 COMMENT '支付状态:1未支付2已支付3已退款',
  `pay_time` DATETIME DEFAULT NULL COMMENT '支付时间',
  `order_status` TINYINT NOT NULL DEFAULT 1 COMMENT '订单状态:1待付款2待发货3已发货4已完成5已取消',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_order_status` (`order_status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_orders_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```
**订单明细表(order_items)**
```sql
CREATE TABLE `order_items` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `order_id` BIGINT UNSIGNED NOT NULL COMMENT '订单ID',
  `product_id` BIGINT UNSIGNED NOT NULL COMMENT '商品ID',
  `sku_id` BIGINT UNSIGNED NOT NULL COMMENT 'SKU ID',
  `product_name` VARCHAR(200) NOT NULL COMMENT '商品名称',
  `product_image` VARCHAR(255) DEFAULT NULL COMMENT '商品图片',
  `spec_combination` VARCHAR(200) DEFAULT NULL COMMENT '规格组合',
  `price` DECIMAL(10,2) NOT NULL COMMENT '单价',
  `quantity` INT NOT NULL COMMENT '数量',
  `subtotal` DECIMAL(10,2) NOT NULL COMMENT '小计',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  CONSTRAINT `fk_order_items_order` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单明细表';
```
#### 5.3.4 社区相关表
**动态表(posts)**
```sql
CREATE TABLE `posts` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `content` TEXT NOT NULL COMMENT '动态内容',
  `images` JSON DEFAULT NULL COMMENT '图片URL数组',
  `video_url` VARCHAR(255) DEFAULT NULL COMMENT '视频URL',
  `video_cover` VARCHAR(255) DEFAULT NULL COMMENT '视频封面',
  `location` VARCHAR(100) DEFAULT NULL COMMENT '地理位置',
  `visibility` TINYINT NOT NULL DEFAULT 1 COMMENT '可见性:1公开2好友3私密',
  `allow_comment` TINYINT NOT NULL DEFAULT 1 COMMENT '允许评论:0否1是',
  `allow_share` TINYINT NOT NULL DEFAULT 1 COMMENT '允许转发:0否1是',
  `likes_count` INT NOT NULL DEFAULT 0 COMMENT '点赞数',
  `comments_count` INT NOT NULL DEFAULT 0 COMMENT '评论数',
  `shares_count` INT NOT NULL DEFAULT 0 COMMENT '转发数',
  `views_count` INT NOT NULL DEFAULT 0 COMMENT '浏览数',
  `is_pinned` TINYINT NOT NULL DEFAULT 0 COMMENT '是否置顶:0否1是',
  `is_featured` TINYINT NOT NULL DEFAULT 0 COMMENT '是否加精:0否1是',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态:1正常2隐藏',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_posts_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='动态表';
```
**评论表(comments)**
```sql
CREATE TABLE `comments` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `post_id` BIGINT UNSIGNED NOT NULL COMMENT '动态ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `parent_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '父评论ID',
  `content` VARCHAR(500) NOT NULL COMMENT '评论内容',
  `likes_count` INT NOT NULL DEFAULT 0 COMMENT '点赞数',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_post_id` (`post_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_parent_id` (`parent_id`),
  CONSTRAINT `fk_comments_post` FOREIGN KEY (`post_id`) REFERENCES `posts` (`id`),
  CONSTRAINT `fk_comments_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论表';
```
### 5.4 索引优化策略
1. **主键索引**：所有表使用自增 BIGINT 作为主键
2. **唯一索引**：用户名、手机号、订单号等唯一字段
3. **普通索引**：外键、状态字段、时间字段
4. **复合索引**：多字段组合查询场景
   **示例：**
```sql
-- 商品列表查询优化
CREATE INDEX idx_category_status_created ON products(category_id, status, created_at);
-- 订单查询优化
CREATE INDEX idx_user_status_created ON orders(user_id, order_status, created_at);
```
### 5.5 数据备份策略
1. **全量备份**：每天凌晨 3 点执行
2. **增量备份**：每 6 小时一次
3. **binlog 备份**：实时备份
4. **备份保留**：30 天
5. **异地备份**：主备份+OSS 存储
