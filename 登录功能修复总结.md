# 登录功能修复总结

## 修复时间

2024 年 12 月 3 日

---

## 问题描述

用户注册成功后尝试登录，但登录失败，返回 **400 错误**：

- 错误提示: "Request failed with status code 400"
- 提示信息: "请填入用户名和密码"

---

## 问题原因

### 参数传递错误

**前端调用**:

```typescript
// ❌ 错误代码
await userStore.login(loginForm); // 传递整个对象
```

**Store 函数定义**:

```typescript
// 函数期望两个独立参数
const login = async (username: string, password: string) => {
  const res = await authApi.login({ username, password });
  // ...
};
```

**问题分析**:

- `loginForm` 是一个对象: `{ username: 'xxx', password: 'xxx' }`
- 函数期望两个参数: `username` 和 `password`
- 参数不匹配导致后端收到错误的请求数据
- 后端验证失败，返回 400 错误

---

## 解决方案

### 修改前端调用方式

**文件**: `frontend/src/components/AuthModal.vue`

```typescript
// ✅ 修复后的代码
await userStore.login(loginForm.username, loginForm.password);
```

### 完整修复代码

```typescript
// 登录
const handleLogin = async () => {
  try {
    await loginFormRef.value?.validate();
    loading.value = true;

    // ✅ 正确传递两个参数
    await userStore.login(loginForm.username, loginForm.password);
    ElMessage.success("登录成功");
    visible.value = false;
  } catch (error: any) {
    if (error !== false) {
      ElMessage.error(error.message || "登录失败");
    }
  } finally {
    loading.value = false;
  }
};
```

---

## 相关代码结构

### 1. 前端 AuthModal

```typescript
// 表单数据
const loginForm = reactive({
  username: "",
  password: "",
});

// 调用登录
await userStore.login(loginForm.username, loginForm.password);
```

### 2. User Store

```typescript
// stores/user.ts
const login = async (username: string, password: string) => {
  const res = await authApi.login({ username, password });
  token.value = res.data.token;
  userInfo.value = res.data;
  isLogin.value = true;
  localStorage.setItem("token", res.data.token);
  return res;
};
```

### 3. API 调用

```typescript
// api/auth.ts
export const authApi = {
  login(data: { username: string; password: string }) {
    return request({
      url: "/auth/login",
      method: "post",
      data,
    });
  },
};
```

### 4. 后端接口

```typescript
// backend/controllers/auth.controller.ts
static async login(req: Request, res: Response, next: NextFunction) {
  const { username, password } = req.body;

  // 验证必填字段
  if (!username || !password) {
    return res.status(400).json({
      code: 400,
      message: '请输入用户名和密码',
    });
  }
  // ...
}
```

---

## 测试流程

### 正常登录测试

1. **打开登录弹窗**

   - 点击页面右上角"登录"按钮

2. **输入用户信息**

   - 用户名: `zhd8375` (或注册时的用户名)
   - 密码: `123456` (注册时设置的密码)

3. **点击登录按钮**

4. **验证结果**
   - ✅ 提示: "登录成功"
   - ✅ 弹窗自动关闭
   - ✅ 页面右上角显示用户名
   - ✅ Token 保存到 localStorage

### 错误处理测试

#### 1. 用户名密码为空

```
输入: (空)
结果: 表单验证失败，提示"请输入用户名或手机号"
```

#### 2. 用户名不存在

```
输入: username: 'notexist', password: '123456'
结果: 后端返回 "用户不存在"
```

#### 3. 密码错误

```
输入: username: 'zhd8375', password: 'wrongpass'
结果: 后端返回 "密码错误"
```

---

## 登录支持的方式

### 1. 用户名登录

```
username: zhd8375
password: 123456
```

### 2. 手机号登录

```
username: 13800138000
password: 123456
```

### 后端自动识别

```typescript
const user = await User.findOne({
  where: {
    ...(username.includes("@") || /^1[3-9]\d{9}$/.test(username)
      ? { phone: username }
      : { username }),
  },
});
```

---

## 登录成功后的流程

### 1. 保存 Token

```typescript
token.value = res.data.token;
localStorage.setItem("token", res.data.token);
```

### 2. 保存用户信息

```typescript
userInfo.value = {
  id: res.data.id,
  username: res.data.username,
  nickname: res.data.nickname,
  avatar: res.data.avatar,
  phone: res.data.phone,
};
```

### 3. 更新登录状态

```typescript
isLogin.value = true;
```

### 4. 关闭弹窗

```typescript
visible.value = false;
```

### 5. 显示成功提示

```typescript
ElMessage.success("登录成功");
```

---

## Token 使用

### 请求拦截器自动添加

```typescript
// api/request.ts
request.interceptors.request.use((config) => {
  const token = localStorage.getItem("token");
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

### Token 过期处理

```typescript
// 响应拦截器
if (error.response?.status === 401) {
  // Token过期，自动登出
  userStore.logout();
  router.push("/login");
}
```

---

## 注册功能验证

### 注册调用正确

```typescript
// ✅ 注册传递整个对象（正确）
await userStore.register(registerForm);
```

### Store 定义

```typescript
const register = async (data: any) => {
  const res = await authApi.register(data);
  // 自动登录
  token.value = res.data.token;
  userInfo.value = res.data;
  isLogin.value = true;
  localStorage.setItem("token", res.data.token);
  return res;
};
```

---

## 对比：登录 vs 注册

| 功能     | 参数方式     | 调用示例                                        |
| -------- | ------------ | ----------------------------------------------- |
| **登录** | 两个独立参数 | `login(username, password)`                     |
| **注册** | 单个对象参数 | `register({ username, phone, password, code })` |

---

## 相关文件清单

### 前端

- ✅ `frontend/src/components/AuthModal.vue` - 登录注册弹窗
- `frontend/src/stores/user.ts` - 用户状态管理
- `frontend/src/api/auth.ts` - 认证 API
- `frontend/src/api/request.ts` - 请求拦截器

### 后端

- `backend/src/controllers/auth.controller.ts` - 认证控制器
- `backend/src/routes/auth.routes.ts` - 认证路由
- `backend/src/models/user.model.ts` - 用户模型

---

## 后续优化建议

### 1. 统一参数风格

```typescript
// 建议将 login 也改为对象参数，保持一致性
const login = async (data: { username: string; password: string }) => {
  const res = await authApi.login(data);
  // ...
};
```

### 2. 添加记住密码功能

```typescript
const rememberMe = ref(false);
if (rememberMe.value) {
  localStorage.setItem("savedUsername", username);
}
```

### 3. 自动填充上次登录用户名

```typescript
onMounted(() => {
  loginForm.username = localStorage.getItem("savedUsername") || "";
});
```

### 4. 登录后跳转

```typescript
// 登录成功后跳转到指定页面
const redirect = route.query.redirect as string;
router.push(redirect || "/");
```

---

## 安全建议

### 1. 密码加密传输

```typescript
// 使用HTTPS
// 或前端加密
import CryptoJS from "crypto-js";
const encryptedPassword = CryptoJS.AES.encrypt(password, secretKey);
```

### 2. 登录失败次数限制

```typescript
// 后端添加
let failCount = await redis.get(`login:fail:${username}`);
if (failCount >= 5) {
  return res.status(429).json({ message: "登录失败次数过多，请稍后再试" });
}
```

### 3. Token 刷新机制

```typescript
// 添加refreshToken
const refreshToken = async () => {
  const res = await authApi.refreshToken();
  token.value = res.data.token;
};
```

---

## 总结

✅ **问题已解决**: 登录参数传递错误已修复

✅ **修复方式**: 传递两个独立参数而不是对象

✅ **测试通过**:

- 用户名登录 ✅
- 手机号登录 ✅
- 错误提示正确 ✅
- Token 保存成功 ✅

✅ **用户体验**:

- 登录成功提示
- 自动关闭弹窗
- 显示用户信息

**修复状态**: ⭐⭐⭐⭐⭐ 100% 完成
