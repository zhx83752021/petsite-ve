# 购物车功能测试指南

## 已完成的修复

### 1. ✅ 购物车页面加载

- 移除了会导致 500 错误的关联查询
- 添加了详细的日志输出
- 现在可以正常显示空购物车

### 2. ✅ 加入购物车功能

- 商品详情页的"加入购物车"按钮现在会调用真实 API
- 修正了参数名称：`skuId` (之前错误地使用了 `sku`)
- 添加了错误处理和登录检查

### 3. ✅ API 参数修复

- 前端 API 接口参数：`{ productId, quantity, skuId }`
- 后端期望参数：`{ productId, quantity, skuId }`
- 现在完全匹配 ✅

---

## 测试步骤

### 前置条件

- ✅ 后端运行在：http://localhost:3001
- ✅ 前端运行在：http://localhost:5174
- ✅ 已登录用户账号

### 步骤 1：测试加入购物车

1. **访问商品详情页**

   ```
   http://localhost:5174/shop/product/1
   ```

2. **选择商品规格**

   - 点击一个规格（如"3kg"）
   - 确保规格被选中（高亮显示）

3. **设置数量**

   - 可以增减数量（默认为 1）

4. **点击"加入购物车"按钮**

   - 应该显示"已加入购物车"提示
   - 不应该有错误提示

5. **查看浏览器控制台（F12）**
   ```
   应该看到类似的日志：
   POST http://localhost:3001/api/cart
   Status: 200
   Response: {code: 200, message: '添加成功'}
   ```

### 步骤 2：验证购物车数据

1. **访问购物车页面**

   ```
   http://localhost:5174/cart
   ```

2. **刷新页面**（Ctrl+Shift+R）

3. **查看控制台日志**

   ```
   开始加载购物车... Token: true
   购物车API响应: {code: 200, data: [...], message: '获取成功'}
   购物车商品数量: 1   <- 应该大于0
   ```

4. **查看页面**
   - 应该显示刚才添加的商品
   - 商品名称会显示为"商品"（临时，因为简化了查询）
   - 数量应该正确

---

## 如果购物车还是空的

### 检查清单

#### 1. 确认加入购物车成功

打开浏览器控制台（F12）→ Network 标签：

- 找到 `POST /api/cart` 请求
- 查看 Response：应该是 `{code: 200, message: '添加成功'}`
- 如果是 401：说明未登录
- 如果是 404：说明商品或 SKU 不存在
- 如果是 500：查看后端日志

#### 2. 确认用户已登录

在控制台执行：

```javascript
console.log("Token:", localStorage.getItem("token"));
```

- 应该有一个长字符串
- 如果是 null：需要先登录

#### 3. 查看后端日志

后端终端应该显示：

```
[info]: 获取用户 X 的购物车
[info]: 找到 1 个购物车项
```

#### 4. 检查数据库

可以直接查询数据库：

```sql
SELECT * FROM cart_items;
```

---

## 已知限制（当前版本）

### 1. 商品信息显示简化

- 商品名称：显示为"商品"
- 商品图片：不显示
- 商品价格：显示为 0

**原因**：为了避免 500 错误，暂时移除了关联查询

**后续优化**：

- 需要修复数据库字段映射问题
- 然后可以添加回关联查询
- 显示完整的商品信息

### 2. 购物车页面不会自动刷新

- 加入购物车后，需要手动刷新购物车页面
- 可以按 F5 或 Ctrl+R 刷新

**后续优化**：

- 使用 Pinia store 管理购物车状态
- 实现全局购物车数量徽章
- 添加自动刷新机制

---

## 调试技巧

### 1. 查看完整的 API 请求

```javascript
// 在浏览器控制台执行
fetch("http://localhost:3001/api/cart", {
  headers: {
    Authorization: "Bearer " + localStorage.getItem("token"),
  },
})
  .then((r) => r.json())
  .then((d) => console.log("购物车数据:", d));
```

### 2. 手动添加测试数据

```javascript
// 在浏览器控制台执行
fetch("http://localhost:3001/api/cart", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Authorization: "Bearer " + localStorage.getItem("token"),
  },
  body: JSON.stringify({
    productId: 1,
    quantity: 2,
    skuId: 1,
  }),
})
  .then((r) => r.json())
  .then((d) => console.log("添加结果:", d));
```

### 3. 查看后端日志

后端终端会显示详细的操作日志：

- SQL 查询
- 用户 ID
- 找到的购物车项数量
- 错误堆栈（如果有）

---

## 下一步优化建议

1. **修复字段映射** - 使关联查询正常工作
2. **显示完整商品信息** - 名称、图片、价格
3. **添加购物车状态管理** - 使用 Pinia
4. **实现购物车数量角标** - 顶部导航栏显示商品数量
5. **添加自动刷新** - 加入购物车后自动更新
6. **优化用户体验** - 加载动画、更好的错误提示

---

## 当前系统状态

- ✅ 后端：http://localhost:3001 (正常运行)
- ✅ 前端：http://localhost:5174 (正常运行)
- ✅ 数据库：已连接，cart_items 表已创建
- ✅ 购物车 API：基本功能可用
- ⚠️ 商品信息：显示简化（临时）
- ⚠️ 自动同步：需要手动刷新

---

**现在请按照测试步骤操作，验证加入购物车功能！**
