# 购物车图片显示修复总结

## 问题描述

1. 购物车页面中的商品图片无法显示，只显示图片占位符
2. 加载购物车时报错："字段 CartItem.createdAt 不存在"

## 问题原因

### 问题 1：图片无法显示

在 `backend/src/controllers/cart.controller.ts` 的 `getList` 方法中，返回的购物车数据是硬编码的临时数据：

```typescript
const data = cartItems.map((item) => ({
  id: item.id,
  product_id: item.productId,
  name: "商品", // 临时名称
  image: "", // 空字符串 - 这导致图片无法显示
  price: 0,
  quantity: item.quantity,
  stock: 999,
  sku: "",
}));
```

### 问题 2：字段名错误

在查询购物车项时使用了 `createdAt` 字段排序：

```typescript
order: [["createdAt", "DESC"]];
```

虽然 CartItem 模型设置了 `underscored: true`，但在某些情况下，Sequelize 可能无法正确转换字段名，导致查询失败。

## 解决方案

### 修改 1：查询真实商品信息

修改购物车列表 API，从数据库中查询真实的商品信息：

### 修改内容

1. **查询商品信息**：从 `Product` 表获取商品名称和主图
2. **查询 SKU 信息**：从 `ProductSku` 表获取价格、库存和规格
3. **异步处理**：使用 `Promise.all` 并发查询所有购物车项的详细信息

### 关键代码

```typescript
// 获取每个购物车项的详细信息
const data = await Promise.all(
  cartItems.map(async (item) => {
    // 获取商品信息
    const product = await Product.findByPk(item.productId, {
      attributes: ["id", "name", "mainImages"],
    });

    // 获取SKU信息
    let price = 0;
    let stock = 0;
    let skuName = "";

    if (item.skuId) {
      const sku = await ProductSku.findByPk(item.skuId, {
        attributes: ["id", "specCombination", "price", "stock"],
      });
      if (sku) {
        price = Number(sku.price);
        stock = sku.stock;
        skuName = sku.specCombination;
      }
    }

    return {
      id: item.id,
      product_id: item.productId,
      name: product?.name || "商品",
      image: product?.mainImages?.[0] || "", // 使用商品的第一张主图
      price,
      quantity: item.quantity,
      stock,
      sku: skuName,
    };
  })
);
```

### 修改 2：修复排序字段

将排序字段从 `createdAt` 改为 `id`，避免字段名转换问题：

```typescript
// 获取购物车项
const cartItems = await CartItem.findAll({
  where: { userId },
  order: [["id", "DESC"]], // 使用id排序，避免字段名问题
});
```

## 修改文件

- `backend/src/controllers/cart.controller.ts`

## 测试步骤

1. 确保已登录用户账号
2. 访问商品详情页，加入商品到购物车
3. 访问购物车页面：http://localhost:5173/cart
4. 验证商品图片、名称、价格、规格等信息正确显示

## 服务器状态

- ✅ 后端：http://localhost:3002
- ✅ 前端：http://localhost:5173

## 完成时间

2025 年 12 月 3 日
