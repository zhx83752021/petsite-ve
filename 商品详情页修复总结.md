# 商品详情页加入购物车功能修复总结

## 问题描述

在商品详情页点击"加入购物车"按钮时，出现两个错误提示：

1. "请求的资源不存在"
2. "加入购物车失败"

## 根本原因

1. **商品 API 权限限制**：商品路由(`/admin/products`)需要管理员认证，前台用户无法访问
2. **前端使用模拟数据**：由于无法访问商品 API，前端只能使用硬编码的模拟数据
3. **SKU ID 不匹配**：模拟数据中的 SKU ID 在数据库中不存在，导致购物车添加失败

## 解决方案

### 后端修改

#### 1. 创建公开商品控制器 (`backend/src/controllers/shop.controller.ts`)

- 提供不需要管理员权限的商品查询 API
- 实现商品列表和详情接口
- 从 Product 和 ProductSku 模型中正确获取数据

#### 2. 创建公开商品路由 (`backend/src/routes/shop.routes.ts`)

- 路由路径：`/shop/products`（列表）和 `/shop/products/:id`（详情）
- 不需要认证，公开访问

#### 3. 更新路由配置 (`backend/src/routes/index.ts`)

- 添加 `/shop` 路由，挂载公开商品 API

### 前端修改

#### 1. 创建商品 API 模块 (`frontend/src/api/product.ts`)

- 封装商品列表和详情 API 调用

#### 2. 修改商品详情页 (`frontend/src/views/shop/ProductDetail.vue`)

- 导入并调用真实的商品 API
- 替换模拟数据为 API 返回的真实数据
- 正确映射后端数据结构到前端格式

#### 3. 更新环境配置 (`frontend/.env.development`)

- 将 API 基础 URL 从 `http://localhost:3001/api` 更新为 `http://localhost:3002/api`

## 关键技术细节

### Product 模型字段映射

- `mainImages`：商品主图数组
- `detail`：商品详情（注意是单数，不是 details）
- `subtitle`：副标题（映射到前端的 description）
- 价格和库存信息从 ProductSku 模型获取

### SKU 数据处理

- 计算最低价格作为商品展示价格
- 计算最高原价作为划线价
- 汇总所有 SKU 的库存作为总库存

## 测试步骤

1. **确保服务器运行**

   - 后端：运行在 `http://localhost:3002`
   - 前端：运行在 `http://localhost:5173`

2. **访问商品详情页**

   - 已创建测试商品（ID=1）："皇家小型成犬粮"
   - 访问地址：`http://localhost:5173/product/1`
   - 该商品有 3 个 SKU：2kg、8kg、15kg

3. **测试加入购物车**

   - 选择商品规格
   - 设置购买数量
   - 点击"加入购物车"按钮
   - 应该显示"已加入购物车"提示

## 创建测试商品

已创建以下测试脚本：`backend/scripts/add-test-product.ts`

运行方式：

```bash
cd backend
npx ts-node scripts/add-test-product.ts
```

此脚本会自动创建：

- 默认分类："宠物食品"
- 默认品牌："皇家"
- 测试商品："皇家小型成犬粮"（带 3 个 SKU）

## 注意事项

1. **数据库必须有商品数据**：如果数据库为空，需要先通过后台管理系统创建商品和 SKU
2. **需要登录**：加入购物车需要用户登录，未登录会提示"请先登录"
3. **端口变更**：后端端口从 3001 变更为 3002，需要重启服务以应用新配置

## 文件清单

### 新增文件

- `backend/src/controllers/shop.controller.ts`
- `backend/src/routes/shop.routes.ts`
- `frontend/src/api/product.ts`

### 修改文件

- `backend/src/routes/index.ts`
- `frontend/src/views/shop/ProductDetail.vue`
- `frontend/.env.development`

## 完成时间

2025 年 12 月 3 日
