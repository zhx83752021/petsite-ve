# 商城列表页修复总结

## 问题描述

商城列表页（http://localhost:5175/shop）只有 ID=1 的商品能够正常加入购物车，其他商品点击加入购物车失败。

## 问题原因

### 1. 商品数据不足

数据库中只有 1 个测试商品（ID=1），其他商品数据不存在。

### 2. 使用模拟数据

商城列表页面 `frontend/src/views/shop/Index.vue` 使用的是硬编码的模拟数据：

```typescript
products.value = [
  {
    id: "1",
    image: "https://...",
    name: "皇家小型成犬粮 8kg",
    // ...
  },
  {
    id: "2", // 这个ID在数据库中不存在
    image: "https://...",
    name: "猫咪自动喂食器",
    // ...
  },
  // ... 更多模拟数据
];
```

前端显示的商品 ID（2-6）在数据库中并不存在，导致加入购物车时找不到对应的商品和 SKU。

### 3. 后端 API 排序字段错误

商城列表 API 在查询商品时使用了 `createdAt` 字段排序：

```typescript
order: [["createdAt", "DESC"]];
```

虽然 Product 模型设置了 `timestamps: true` 和 `underscored: true`，但 Sequelize 在某些情况下无法正确转换字段名，导致 SQL 查询失败。

## 解决方案

### 1. 创建测试商品数据

创建脚本 `backend/scripts/add-more-products.ts`，批量添加测试商品：

- 猫咪自动喂食器（ID=2，7）
- 宠物互动玩具球（ID=3，9）
- 狗狗磨牙棒套装（ID=4，10）
- 渴望成犬粮（ID=5，11）
- 猫咪自动饮水器（ID=6，12）
- 宠物智能项圈（ID=8，13）

每个商品都包含 2 个 SKU 规格，所有商品均为上架状态（status=1）。

### 2. 修改商城列表页调用真实 API

#### 导入必要模块

```typescript
import { productApi } from "@/api/product";
import { ElMessage } from "element-plus";
```

#### 修改 loadProducts 函数

```typescript
const loadProducts = async () => {
  loading.value = true;
  try {
    const res = await productApi.getList({
      page: pagination.page,
      pageSize: pagination.pageSize,
    });

    const data = res.data;

    // 转换后端数据为前端格式
    products.value = data.items.map((item: any) => ({
      id: String(item.id),
      image: item.image || item.images?.[0] || "默认图片",
      name: item.name,
      price: item.price,
      originalPrice: item.originalPrice,
      sales: item.sales || 0,
      rating: 4.8,
      tags: [],
    }));

    totalCount.value = data.pagination?.total || data.items.length;
  } catch (error: any) {
    console.error("加载商品列表失败:", error);
    ElMessage.error("加载商品列表失败");
    products.value = [];
    totalCount.value = 0;
  } finally {
    loading.value = false;
  }
};
```

### 3. 修复后端排序字段

修改 `backend/src/controllers/shop.controller.ts`，将排序字段从 `createdAt` 改为 `id`：

```typescript
const { count, rows } = await Product.findAndCountAll({
  where,
  attributes: ["id", "name", "mainImages", "subtitle", "sales", "views"],
  offset,
  limit: Number(pageSize),
  order: [["id", "DESC"]], // 使用id排序，避免字段名问题
});
```

## 修改文件

### 新增文件

- `backend/scripts/add-more-products.ts` - 批量创建测试商品脚本

### 修改文件

- `frontend/src/views/shop/Index.vue` - 商城列表页面，改用真实 API
- `backend/src/controllers/shop.controller.ts` - 修复商品列表查询的排序字段
- `frontend/.env.development` - 更新 API 端口配置

## 测试步骤

### 1. 创建测试商品

```bash
cd backend
npx ts-node scripts/add-more-products.ts
```

### 2. 访问商城列表

访问：http://localhost:5175/shop

### 3. 验证功能

1. 商品列表正确显示
2. 商品图片、名称、价格显示正常
3. 点击任意商品卡片，跳转到对应的商品详情页
4. 在商品详情页选择规格，加入购物车成功

## 数据库商品列表

| ID  | 商品名称       | SKU 数量 |
| --- | -------------- | -------- |
| 1   | 皇家小型成犬粮 | 3        |
| 2   | 猫咪自动喂食器 | 2        |
| 3   | 宠物互动玩具球 | 2        |
| 4   | 狗狗磨牙棒套装 | 2        |
| 5   | 渴望成犬粮     | 2        |
| 6   | 猫咪自动饮水器 | 2        |
| 7   | 猫咪自动喂食器 | 2        |
| 8   | 宠物智能项圈   | 2        |

## 服务器状态

- ✅ 后端：http://localhost:3001
- ✅ 前端：http://localhost:5175

## 完成时间

2025 年 12 月 3 日

## 注意事项

1. 所有商品均已上架（status=1）
2. 每个商品都有完整的 SKU 数据，可以正常加入购物车
3. 前端端口从 5173 变更为 5175
4. 商城列表页现在会从真实 API 获取数据，支持分页
5. 后端排序字段使用 `id` 而非 `createdAt`，避免字段名转换问题
6. 后端 API 端口为 3001，前端已同步更新配置
