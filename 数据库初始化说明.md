# 数据库初始化说明

## 🎯 当前问题

从部署结果看，数据库表结构存在但**数据为空或字段不匹配**，导致 API 返回错误。

## 📋 数据库表状态

根据之前的检查：

### ✅ 已存在的表

- `users` - 1 条数据
- `products` - 5 条数据
- `categories` - 4 条数据
- `product_skus` - 5 条数据
- `orders` - 0 条数据
- `order_items` - 0 条数据
- `cart_items` - 0 条数据
- `addresses` - 0 条数据

### ❌ 可能缺少的表

- `admins` - 已创建
- `brands` - 可能不存在
- `posts` - 可能不存在

## 🔧 解决方案

### 方案 1: 直接在数据库执行 SQL（推荐）

登录你的 PostgreSQL 数据库，执行以下 SQL：

```sql
-- 创建 brands 表（如果不存在）
CREATE TABLE IF NOT EXISTS brands (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  logo VARCHAR(255),
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 插入示例品牌数据
INSERT INTO brands (name, logo, description) VALUES
('皇家宠物', 'https://via.placeholder.com/100', '专业宠物食品品牌'),
('宝路', 'https://via.placeholder.com/100', '知名狗粮品牌'),
('伟嘉', 'https://via.placeholder.com/100', '优质猫粮品牌')
ON CONFLICT DO NOTHING;

-- 创建 posts 表（如果不存在）
CREATE TABLE IF NOT EXISTS posts (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  content TEXT NOT NULL,
  images JSONB DEFAULT '[]',
  status VARCHAR(20) DEFAULT 'published',
  like_count INTEGER DEFAULT 0,
  comment_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 插入示例动态数据
INSERT INTO posts (user_id, content, status, like_count, comment_count) VALUES
(1, '我家的狗狗今天特别可爱！', 'published', 10, 5),
(1, '分享一款好用的猫粮，推荐给大家~', 'published', 8, 3),
(1, '宠物美容心得分享', 'published', 15, 8)
ON CONFLICT DO NOTHING;
```

### 方案 2: 检查现有数据

如果表已存在但数据有问题，执行：

```sql
-- 检查 products 表结构
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'products'
ORDER BY ordinal_position;

-- 检查现有商品数据
SELECT id, name, description, category_id
FROM products
LIMIT 5;

-- 检查 product_skus
SELECT ps.id, ps.product_id, p.name, ps.price, ps.stock
FROM product_skus ps
JOIN products p ON ps.product_id = p.id
LIMIT 10;
```

### 方案 3: 修复 products 表可能缺少的字段

如果 products 表缺少某些字段：

```sql
-- 添加可能缺少的字段
ALTER TABLE products
ADD COLUMN IF NOT EXISTS images JSONB DEFAULT '[]',
ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT NOW(),
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP DEFAULT NOW();

-- 更新现有商品的时间戳
UPDATE products
SET created_at = NOW(), updated_at = NOW()
WHERE created_at IS NULL;
```

## 🎯 快速诊断步骤

1. **访问 Vercel 控制台**

   - 进入项目 → Functions
   - 点击 `/api/shop/products`
   - 查看 Logs 获取具体错误信息

2. **常见错误及解决**

   **错误**: `column "images" does not exist`

   - 解决: 执行方案 3，添加缺少的字段

   **错误**: `relation "brands" does not exist`

   - 解决: 执行方案 1，创建 brands 表

   **错误**: `null value in column "xxx" violates not-null constraint`

   - 解决: 检查表结构，移除 NOT NULL 约束或提供默认值

## 📝 最简单的验证方法

在数据库中执行：

```sql
-- 测试商品查询（模拟API）
SELECT
  p.id,
  p.name,
  p.description,
  p.category_id
FROM products p
ORDER BY p.id DESC
LIMIT 5;

-- 如果上面成功，再测试SKU关联
SELECT
  p.id,
  p.name,
  MIN(ps.price) as min_price,
  SUM(ps.stock) as total_stock
FROM products p
LEFT JOIN product_skus ps ON p.id = ps.product_id
GROUP BY p.id, p.name
LIMIT 5;
```

如果以上查询都成功，说明数据库没问题，可能是：

1. 代码还未部署完成（等待 1-2 分钟）
2. 环境变量配置问题
3. API 代码逻辑错误

## 🔍 下一步行动

请执行以下任一操作：

1. **查看 Vercel Function 日志** 获取具体错误
2. **在数据库执行方案 1 的 SQL** 创建缺失的表
3. **告诉我具体的错误信息** 我来针对性修复

---

**临时解决方案**: 如果急需查看效果，可以先让 API 返回模拟数据，确认前端功能正常。
