# 后端服务启动说明

## 启动方式

### 方式一：标准启动（推荐）

```bash
npm run dev
```

- 使用 nodemon 自动监听文件变化
- **智能端口处理**：如果配置的端口被占用，会自动查找并使用下一个可用端口
- 支持热重载，修改代码后自动重启

### 方式二：清理端口后启动

```bash
npm run dev:clean
```

- 自动检测并停止占用端口的进程
- 然后启动开发服务器
- 适合端口被其他程序占用的情况

### 方式三：手动清理端口

如果遇到端口占用问题，可以手动执行：

#### Windows PowerShell

```powershell
# 查找占用端口 3001 的进程
netstat -ano | findstr :3001

# 停止进程（替换 <PID> 为实际进程ID）
taskkill /F /PID <PID>
```

## 端口配置

端口在 `.env.development` 文件中配置：

```
PORT=3001
```

## 智能端口处理功能

后端服务现在具备以下功能：

### 1. 自动端口检测

启动时会自动检测配置的端口是否可用

### 2. 自动查找可用端口

如果配置的端口被占用，会自动在以下范围查找可用端口：

- 起始端口：配置端口（如 3001）
- 查找范围：配置端口 + 10（如 3001-3010）

### 3. 优雅关闭

- 按 `Ctrl+C` 可以优雅地关闭服务器
- 服务器会等待所有请求完成后再关闭
- 如果 10 秒内未完成，会强制关闭

### 4. 错误处理

- 完善的错误日志记录
- 自动处理未捕获的异常和 Promise 拒绝

## 常见问题

### Q: 为什么总是提示端口被占用？

A: 可能的原因：

1. 之前启动的服务未正常关闭
2. 其他应用占用了端口
3. 同时启动了多个服务实例

解决方案：

- 使用 `npm run dev:clean` 启动（会自动清理端口）
- 或手动清理端口后再启动

### Q: 如何完全停止所有后端服务？

A:

```powershell
# 查找所有 node 进程
Get-Process node

# 停止所有 node 进程（谨慎使用）
Get-Process node | Stop-Process -Force
```

### Q: 服务启动成功，但前端无法访问？

A: 检查以下几点：

1. 确认服务器实际运行的端口（查看日志输出）
2. 检查前端的 API 地址配置是否正确
3. 确认 CORS 配置是否正确

## 日志查看

服务器启动后会显示：

```
服务器运行在端口 3001
环境: development
API 地址: http://localhost:3001/api
```

如果端口被占用，会显示：

```
端口 3001 已被占用，正在查找可用端口...
使用替代端口: 3002
```

## 开发建议

1. **使用 nodemon**：开发时建议使用 `npm run dev`，修改代码后自动重启
2. **检查日志**：启动失败时注意查看错误日志
3. **定期清理**：定期检查并清理不需要的 node 进程
4. **统一端口**：团队开发时建议统一使用相同的端口配置

## 生产环境

生产环境启动：

```bash
# 构建
npm run build

# 启动
npm start
```

生产环境不会自动查找端口，如果端口被占用会直接报错退出。
